# Parallel Ensemble Pipeline
# Runs multiple models in parallel and evaluates each
# Flow: load_data → preprocess → [xgb | catboost | kmeans] parallel → eval_xgb, eval_cat → log

pipeline:
  name: "parallel_ensemble"

  steps:
    # Stage 1: Data Loading
    - id: "load_data"
      type: "data_loader"
      enabled: true

    - id: "init_artifacts"
      type: "mlflow_loader"
      enabled: true
      alias: "latest"
      load_map:
        - { step_id: "preprocess", context_key: "fitted_preprocess" }
        - { step_id: "xgboost_branch", context_key: "fitted_xgboost_branch" }
        - { step_id: "catboost_branch", context_key: "fitted_catboost_branch" }
        - { step_id: "kmeans_branch", context_key: "fitted_kmeans_branch" }

    # Stage 2: Preprocessing
    - id: "preprocess"
      type: "preprocessor"
      enabled: true
      depends_on: ["load_data"]
      instance_key: "fitted_preprocess"
      is_train: false  # Important: loads fitted state from context instead of refitting
      wiring:
        outputs: { "features": "preprocessed_data",
                   "targets": "target_data" }


    - id: "eval_catboost"
      type: "evaluator"
      enabled: true
      depends_on: ["init_artifacts", "preprocess"]
      wiring:
        inputs:
          features: "preprocessed_data"
          targets: "target_data"
          model: fitted_catboost_branch
        outputs:
          metrics: "catboost_metrics"

    - id: "eval_xgboost"
      type: "evaluator"
      enabled: true
      depends_on: ["init_artifacts", "preprocess"]
      wiring:
        inputs:
          features: "preprocessed_data"
          targets: "target_data"
          model: fitted_xgboost_branch
        outputs:
          metrics: "xgboost_metrics"

    - id: "eval_kmean"
      type: "evaluator"
      enabled: true
      step_eval_type: clustering
      depends_on: ["init_artifacts", "preprocess"]
      wiring:
        inputs:
          features: "preprocessed_data"
          targets: "target_data"
          model: fitted_kmeans_branch
        outputs:
          metrics: "kmean_metrics"

    # Stage 6: Logging (log best model - xgboost as default)
    - id: "log_results"
      type: "logger"
      enabled: true
      depends_on: ["eval_catboost", "eval_xgboost", eval_kmean]
      wiring:
        inputs:
          model: "xgb_model"
          metrics: "xgb_metrics"
