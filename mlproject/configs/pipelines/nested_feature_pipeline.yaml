# Nested Sub-Pipeline Example
# Uses sub-pipeline for feature engineering
#
# Flow: load_data → preprocess → feature_pipeline(sub) → train_model → evaluate → log

pipeline:
  name: "nested_feature_engineering"

  steps:
    # Stage 1: Data Loading
    - id: "load_data"
      type: "data_loader"
      enabled: true

    # Stage 2: Basic Preprocessing
    - id: "preprocess"
      type: "preprocessor"
      enabled: true
      depends_on: ["load_data"]
      is_train: true

    # Stage 3: Feature Engineering Sub-Pipeline
    - id: "feature_pipeline"
      type: "sub_pipeline"
      enabled: true
      depends_on: ["preprocess"]
      output_prefix: "feat_"
      isolated: false
      wiring:
        inputs:
          input_data: "preprocessed_data"
        outputs:
          features: "engineered_features"

      # Inline sub-pipeline definition
      pipeline:
        steps:
          # Sub-step 1: Clustering for segment features
          - id: "cluster_features"
            type: "clustering"
            model_name: "kmean"
            output_as_feature: true
            hyperparams:
              n_clusters: 4
            wiring:
              inputs:
                data: "preprocessed_data"
              outputs:
                features: "cluster_labels"
                model: "cluster_model"

    # Stage 4: Final Model Training
    # Uses original data + engineered features from sub-pipeline
    - id: "train_model"
      type: "trainer"
      enabled: true
      depends_on: ["feature_pipeline"]
      wiring:
        inputs:
          data: "preprocessed_data"
        outputs:
          model: "final_model"
          datamodule: "final_dm"

    # Stage 5: Evaluation
    - id: "evaluate"
      type: "evaluator"
      enabled: true
      depends_on: ["train_model"]
      model_step_id: "train_model"
      wiring:
        inputs:
          model: "final_model"
          datamodule: "final_dm"
        outputs:
          metrics: "evaluation_metrics"

    # Stage 6: Logging
    - id: "log_results"
      type: "logger"
      enabled: true
      depends_on: ["evaluate"]
      model_step_id: "train_model"
      eval_step_id: "evaluate"
