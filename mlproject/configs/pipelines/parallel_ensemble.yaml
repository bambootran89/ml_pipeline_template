# Parallel Ensemble Pipeline
# Runs multiple models in parallel and evaluates each
# Flow: load_data → preprocess → [xgb | catboost | kmeans] parallel → eval_xgb, eval_cat → log

pipeline:
  name: "parallel_ensemble"

  steps:
    # Stage 1: Data Loading
    - id: "load_data"
      type: "data_loader"
      enabled: true

    # Stage 2: Preprocessing
    - id: "preprocess"
      type: "preprocessor"
      enabled: true
      depends_on: ["load_data"]
      is_train: true

    # Stage 3: Parallel Model Training
    - id: "ensemble_models"
      type: "parallel"
      enabled: true
      depends_on: ["preprocess"]
      max_workers: 3
      merge_strategy: "merge"
      branches:
        # Branch 1: XGBoost
        - id: "xgboost_branch"
          type: "trainer"
          wiring:
            inputs:
              features: "preprocessed_data"
              targets: "target_data"

        # Branch 2: CatBoost (nếu có trong ModelFactory)
        # Nếu chưa có catboost, comment out hoặc thay bằng model khác
        - id: "catboost_branch"
          type: "trainer"
          wiring:
            inputs:
              features: "preprocessed_data"
              targets: "target_data"

        # Branch 3: KMeans clustering features
        - id: "kmeans_branch"
          type: "clustering"
          model_name: "kmean"
          output_as_feature: true
          hyperparams:
            n_clusters: 3
          wiring:
            inputs:
              data: "preprocessed_data"
            outputs:
              features: "cluster_features"
              model: "kmeans_model"

    # Stage 4: Evaluate XGBoost
    - id: "eval_xgb"
      type: "evaluator"
      enabled: true
      depends_on: ["ensemble_models"]
      model_step_id: "xgboost_branch"

    # Stage 5: Evaluate CatBoost
    - id: "eval_cat"
      type: "evaluator"
      enabled: true
      depends_on: ["ensemble_models"]
      model_step_id: "catboost_branch"

    # Stage 6: Logging (log best model - xgboost as default)
    - id: "log_results"
      type: "logger"
      enabled: true
      depends_on: ["eval_xgb", "eval_cat"]
      wiring:
        inputs:
          model: "xgb_model"
          metrics: "xgb_metrics"
