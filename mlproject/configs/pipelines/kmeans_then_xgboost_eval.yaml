pipeline:
  name: "standard_eval"
  steps:

    - id: "load_data"
      type: "data_loader"
      enabled: true
    - id: "init_artifacts"
      type: "mlflow_loader"
      enabled: true
      alias: "latest"
      load_map:
        - { step_id: "kmeans_features", context_key: "kmeans_features_model" }
        - { step_id: "xgboost_model", context_key: "xgboost_model_model" }
        - { step_id: "preprocess", context_key: "fitted_preprocess" }
    - id: "preprocess"
      type: "preprocessor"
      enabled: true
      depends_on: ["load_data", init_artifacts]
      instance_key: "fitted_preprocess"
      is_train: false  # Critical: load existing state from MLflow, do not refit
      alias: "latest"   # Uses the same alias as the model (can be overridden via CLI)


    - id: "kmean_evaluate"
      type: "evaluator"
      enabled: true
      step_eval_type: clustering
      depends_on: ["init_artifacts", "preprocess"]
      wiring:
        inputs:
          features: "preprocessed_data"
          model: kmeans_features_model
        outputs:
          metrics: "kmean_metrics"

    - id: "xgboost_evaluate"
      type: "evaluator"
      enabled: true
      depends_on: ["init_artifacts", "preprocess"]
      wiring:
        inputs:
          features: "preprocessed_data"
          targets: "target_data"
          model: xgboost_model_model
        outputs:
          metrics: "xgboost_metrics"

    # Stage 7: Final profiling
    - id: "final_profiling"
      type: "profiling"
      enabled: true
      depends_on: ["kmean_evaluate", "xgboost_evaluate"]
      exclude_keys: ["cfg", "preprocessor", "df", "train_df", "val_df", "test_df"]

    # Optional step: logs evaluation metrics to storage or tracking systems
    - id: "log_results"
      type: "logger"
      enabled: true  # Disabled by default for evaluation pipelines
      depends_on: ["kmean_evaluate", "xgboost_evaluate"]
