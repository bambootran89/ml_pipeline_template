pipeline:
  name: "standard_tune"
  description: "Tuning pipeline with profiling: load -> preprocess -> tune -> train_best -> evaluate -> profile -> log"

  steps:
    # Stage 1: Data preparation
    - id: "load_data"
      type: "data_loader"
      enabled: true

    - id: "preprocess"
      type: "preprocessor"
      enabled: true
      depends_on: ["load_data"]
      is_train: true

    # Stage 2: Hyperparameter Tuning (Optuna)
    - id: "tune_model"
      type: "tuner"
      enabled: true
      depends_on: ["preprocess"]

    - id: "prepare_data"
      type: "datamodule"
      depends_on: ["preprocess"]
      wiring:
        inputs:
          features: "preprocessed_data"
          targets: "target_data"
        outputs: { datamodule: "prepare_data_datamodule" }

    # Stage 3: Retrain with best params
    - id: "train_best"
      type: "trainer"
      enabled: true
      log_artifact: true
      artifact_type: "model"
      depends_on: ["tune_model", "preprocess"]
      use_tuned_params: true
      tune_step_id: "tune_model"
      wiring:
        inputs:
          features: "preprocessed_data"
          targets: "target_data"
          datamodule: prepare_data_datamodule
        outputs:
          model: "train_model_model"


    # Stage 4: Evaluate final model
    - id: "evaluate"
      type: "evaluator"
      enabled: true
      depends_on: ["train_best"]
      wiring:
        inputs:
          # Load model instance from the trainer step
          model: "train_model_model"
          # Load DataModule from the data preparation step instead of rebuilding it
          datamodule: "prepare_data_datamodule"
        outputs:
          metrics: "evaluation_metrics"

    # Stage 5: Profile outputs (NEW)
    - id: "profiling"
      type: "profiling"
      enabled: true
      depends_on: ["evaluate"]
      exclude_keys: ["cfg", "preprocessor", "df", "train_df", "val_df"]

    # Stage 6: Log to MLflow
    - id: "log_results"
      type: "logger"
      enabled: true
      depends_on: ["train_best", "evaluate", "profiling"]
