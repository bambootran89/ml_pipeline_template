# The feature_pipeline runs:
#   1. Preprocessing (normalize)
#   2. Clustering (generate features)
# Then outputs are prefixed with "feat_" and merged to parent context

pipeline:
  name: "nested_feature_engineering"

  steps:
    # Stage 1: Data Loading
    - id: "load_data"
      type: "data_loader"
      enabled: true

    # Stage 2: Feature Engineering Sub-Pipeline
    - id: "feature_pipeline"
      type: "sub_pipeline"
      enabled: true
      depends_on: ["load_data"]
      output_prefix: "feat_"
      isolated: false

      # Inline pipeline definition
      pipeline:
        steps:
          # Sub-step 1: Preprocessing
          - id: "normalize"
            type: "preprocessor"
            is_train: true
            wiring:
              inputs:
                df: "df"
                train_df: "train_df"
                test_df: "test_df"
              outputs:
                data: "normalized_data"

          # Sub-step 2: Clustering for feature generation
          - id: "cluster"
            type: "clustering"
            depends_on: ["normalize"]
            model_name: "kmean"
            output_as_feature: true
            hyperparams:
              n_clusters: 4
            wiring:
              inputs:
                data: "normalized_data"
              outputs:
                features: "cluster_features"
                model: "cluster_model"

    # Stage 3: Model Training
    # Uses feat_normalized_data (prefixed output from sub-pipeline)
    - id: "train_model"
      type: "trainer"
      enabled: true
      depends_on: ["feature_pipeline"]
      wiring:
        inputs:
          data: "feat_normalized_data"
        outputs:
          model: "final_model"
          datamodule: "final_dm"

    # Stage 4: Evaluation
    - id: "evaluate"
      type: "evaluator"
      enabled: true
      depends_on: ["train_model"]
      model_step_id: "train_model"
      wiring:
        inputs:
          model: "final_model"
          datamodule: "final_dm"
        outputs:
          metrics: "evaluation_metrics"

    # Stage 5: Log Results
    - id: "log_results"
      type: "logger"
      enabled: true
      depends_on: ["evaluate"]
      model_step_id: "train_model"
      eval_step_id: "evaluate"
