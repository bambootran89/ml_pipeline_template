# The feature_pipeline runs:
#   1. Preprocessing (normalize)
#   2. Clustering (generate features)

pipeline:
  name: "nested_feature_engineering"

  steps:
    # Stage 1: Data Loading
    - id: "load_data"
      type: "data_loader"
      enabled: true

    # Step 2: Preprocessing - fit and transform data
    - id: "preprocess"
      type: "preprocessor"
      enabled: true
      log_artifact: true
      artifact_type: "preprocess"
      depends_on: ["load_data"]
      is_train: true

    - id: "prepare_data"
      type: "datamodule"
      depends_on: ["preprocess"]
      wiring:
        inputs:
          features: "preprocessed_data"
          targets: "target_data"
        outputs: { datamodule: "prepare_data_datamodule" }
    # Stage 2: Clustering Sub-Pipeline
    - id: "cluster_pipeline"
      type: "sub_pipeline"
      enabled: true
      depends_on: ["prepare_data"]
      isolated: false
      # Inline pipeline definition
      pipeline:
        steps:
          # Sub-step 1: Clustering for feature generation
          - id: "cluster_type_1"
            type: "clustering"
            model_name: "kmean"
            log_artifact: true
            artifact_type: "model"
            output_as_feature: true
            hyperparams:
              n_clusters: 4
            wiring:
              inputs:
                datamodule: "prepare_data_datamodule"
              outputs:
                features: "cluster_1_features"
                model: "cluster_model_1"
          # Sub-step 1: Clustering for feature generation
          - id: "cluster_type_2"
            type: "clustering"
            model_name: "kmean"
            log_artifact: true
            artifact_type: "model"
            output_as_feature: true
            hyperparams:
              n_clusters: 2
            wiring:
              inputs:
                datamodule: "prepare_data_datamodule"
              outputs:
                features: "cluster_2_features"
                model: "cluster_model_2"

    - id: "train_model"
      type: "trainer"
      enabled: true
      depends_on: ["cluster_pipeline"]
      log_artifact: true
      artifact_type: "model"
      wiring:
        inputs:
          datamodule: "prepare_data_datamodule"
          features: "preprocessed_data"
          targets: "target_data"
        outputs:
          model: "final_model"

    # Stage 4: Evaluation
    - id: "evaluate"
      type: "evaluator"
      enabled: true
      depends_on: ["train_model"]
      wiring:
        inputs:
          model: "final_model"
          datamodule: "prepare_data_datamodule"
        outputs:
          metrics: "evaluation_metrics"

    - id: "final_profiling"
      type: "profiling"
      enabled: true
      depends_on: ["train_model"]
      exclude_keys: ["cfg", "preprocessor", "df", "train_df", "val_df"]

    # Stage 5: Log Results
    - id: "log_results"
      type: "logger"
      enabled: true
      depends_on: ["evaluate"]
